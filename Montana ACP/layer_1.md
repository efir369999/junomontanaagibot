# Слой 1 — Протокольные примитивы для Montana

**Версия:** 1.4
**Дата:** Январь 2026
**Протокол:** Atemporal Coordinate Presence (ACP)
**Зависимость:** Слой -1 v3.2, Слой 0 v2.7

---

## L-1.0 Область применения

Слой 1 определяет протокольные примитивы — криптографические строительные блоки, комбинирующие физические ограничения Слоя -1 с вычислительной сложностью Слоя 0.

**Слой 1 содержит:**
- Детерминированная лотерея (hash-based selection)
- Схемы обязательств (commitments)
- Протоколы временных меток (timestamps)
- Примитивы упорядочивания (ordering)
- P2P-аттестация
- Определения безопасности

Полные протоколы консенсуса определены в Слое 2. Экономические механизмы — в Слое 2+.

---

## L-1.0.1 Эпистемическая классификация

### Унаследованные типы (из L-0)

| Тип | Значение | Пример в L-1 |
|-----|----------|--------------|
| A | Доказано безусловно | Порядок хеш-цепи |
| B | Доказано относительно допущения | Безопасность подписей (ML-LWE) |
| C | Эмпирическая стойкость | SHA3-256 collision resistance |
| P | Физическое ограничение | Координаты упорядочены (L-1.1) |

### Типы конструкций (специфичные для L-1)

| Тип | Значение | Уверенность |
|-----|----------|-------------|
| S | Безопасная композиция | Доказано что X + Y сохраняет безопасность |
| I | Зависит от реализации | Безопасность зависит от корректной реализации |

---

## L-1.1 Детерминированная лотерея

### L-1.1.1 Определение

Детерминированная лотерея — функция выбора победителя, где:

1. **Детерминированность:** Все узлы вычисляют одного победителя
2. **Непредсказуемость:** seed неизвестен до закрытия предыдущего слайса
3. **Верифицируемость:** Любой может проверить корректность выбора

**Тип:** C (hash security) + A (детерминированный алгоритм)

### L-1.1.2 Конструкция

```
seed = SHA3-256(prev_slice_hash ‖ τ₂_index)

prev_slice_hash — хеш предыдущего закрытого слайса (32 байта)
τ₂_index — порядковый номер текущего слайса (8 байт)
```

**Свойства:**
- seed фиксирован после закрытия предыдущего τ₂
- seed раскрывается только при закрытии (prev_slice_hash формируется в этот момент)
- Все узлы имеют одинаковые данные → одинаковый результат

### L-1.1.3 Двухуровневый выбор

```
Stage 1: Выбор пула
├── pool = seed mod 100
├── 0-69  → Full Node pool
├── 70-89 → Light Node pool
└── 90-99 → Light Client pool

Stage 2: Выбор внутри пула
├── nodes = отсортированы по pubkey (детерминированный порядок)
├── weights = кумулятивные веса [w₁, w₁+w₂, ..., Σwᵢ]
├── target = SHA3-256(seed ‖ "stage2") mod Σwᵢ
└── winner = первый узел где cumulative > target
```

### L-1.1.4 Безопасность

**Теорема (Тип C):** Если SHA3-256 preimage-resistant, то:

```
Pr[Adversary предсказывает seed до закрытия τ₂] ≤ negl(λ)
```

**Доказательство:**
- seed = SHA3-256(prev_slice_hash ‖ τ₂_index)
- prev_slice_hash включает presence_root, tx_root, подпись победителя
- Изменить prev_slice_hash = найти preimage или подделать подпись
- Оба требуют нарушения базовых предположений

### L-1.1.5 Защита от grinding

```
Grinding attack: манипулировать входами для выгодного seed

Защита:
├── seed зависит от prev_slice_hash, который фиксирован до формирования текущего τ₂
├── seed вычисляется ДО формирования слайса победителем
├── Победитель получает уже определённый seed
└── prev_slice_hash фиксирован предыдущим победителем
```

| Атака | Защита |
|-------|--------|
| Манипулировать presence_root | seed формируется из prev_slice_hash |
| Манипулировать tx_root | seed формируется из prev_slice_hash |
| Отказаться публиковать слайс | Потеря награды, seed следующего слайса формируется из альтернативного prev |

### L-1.1.6 Зависимости

| Свойство | Зависит от | Режим отказа |
|----------|------------|--------------|
| Детерминированность | Алгоритм (A) | Невозможен (математика) |
| Непредсказуемость | SHA3-256 preimage (C) | Preimage attack → предсказание |
| Верифицируемость | Публичные данные | Невозможен |

---

## L-1.2 Схемы обязательств (Commitments)

### L-1.2.1 Определение

Схема обязательств состоит из:
- Commit(m, r) → c: Создать обязательство на сообщение m с рандомом r
- Open(c, m, r) → {0,1}: Проверить что обязательство открывается в m

**Свойства:**
1. **Hiding:** c скрывает информацию о m
2. **Binding:** c криптографически привязан к единственному m

### L-1.2.2 Hash-based Commitment

**Конструкция (SHA3-256):**

```
Commit(m, r):
  return SHA3-256(r ‖ m)

Open(c, m, r):
  return c == SHA3-256(r ‖ m)
```

**Свойства:**
- Hiding: Computational (Тип C, preimage resistance)
- Binding: Computational (Тип C, collision resistance)
- Постквантовая безопасность: 128 бит

**Тип:** C + C

### L-1.2.3 Применение в Montana

```
presence_root = Merkle(подписи присутствия)
├── Binding: набор подписей криптографически фиксирован после публикации
├── Hiding: подписи публичные (hiding неактуально)
└── Верификация: Merkle proof для любой подписи

tx_root = Merkle(транзакции)
├── Binding: набор транзакций криптографически фиксирован
├── Hiding: транзакции публичные (hiding неактуально)
└── Верификация: Merkle proof для любой транзакции
```

### L-1.2.4 Зависимости

| Свойство | Зависит от | Режим отказа |
|----------|------------|--------------|
| Hash binding | L-0.3.2 (CRHF) | Collision → equivocation |
| Hash hiding | L-0.3.2 (Preimage) | Preimage → раскрытие |

---

## L-1.3 Временные метки (Timestamps)

### L-1.3.1 Определение

Протокол временных меток доказывает что данные D существовали в момент t.

**Свойства:**
1. **Completeness:** Валидные метки проверяются корректно
2. **Unforgeability:** Метка создаётся только для времени существования D и позже
3. **Temporal ordering:** Если D₁ помечена раньше D₂, это верифицируемо

**Тип:** P + B (физическое время + криптографическая привязка)

### L-1.3.2 Linked Timestamping (Хеш-цепь)

**Конструкция:**

```
Slice(N):
├── prev_hash: SHA3-256(Slice(N-1))
├── timestamp: NMI-координата или prev_timestamp + τ₂
├── presence_root: Merkle(подписи)
├── tx_root: Merkle(транзакции)
└── signature: ML-DSA-65(winner, header)
```

**Свойства:**
- Порядок: Тип A (хеш-цепь тотально упорядочена)
- Unforgeability: Тип C (hash preimage) + B (signature)
- Привязка к физическому времени: Тип P (NMI calibration)

### L-1.3.3 Свойства таймчейна

```
Slice 0 → Slice 1 → Slice 2 → ... → Slice N
   │          │          │              │
 genesis   H(S₀)      H(S₁)         H(Sₙ₋₁)
```

| Свойство | Гарантия | Тип |
|----------|----------|-----|
| Тотальный порядок | Каждый слайс ссылается на один предыдущий | A |
| Неизменяемость | Изменение требует collision или forgery | C + B |
| Верифицируемость | Любой может проверить цепь | A |

### L-1.3.4 NMI-калибровка

```
NMI-роль: advisory (только калибровка отображения)

При доступности NMI (≥14 из 21 согласованы):
├── timestamp = NMI-медиана
└── Привязка к SI-секундам

При недоступности NMI:
├── timestamp = prev_timestamp + τ₂
├── Внутренний порядок сохраняется
└── Только отображение некалибровано
```

**Тип:** P (L-1.2 atomic time)

### L-1.3.5 Зависимости

| Свойство | Зависит от | Режим отказа |
|----------|------------|--------------|
| Hash binding | L-0.3.2 (CRHF) | Collision → reorder |
| Signature | L-0.3.3 (ML-LWE) | Forgery → fake slices |
| Temporal validity | L-1.2 (NMI) | Drift отображения |

---

## L-1.4 Примитивы упорядочивания

### L-1.4.1 Тотальный порядок

**Определение:** Тотальный порядок на множестве S — отношение ≤ такое что:
- Рефлексивность: a ≤ a
- Антисимметричность: a ≤ b и b ≤ a ⟹ a = b
- Транзитивность: a ≤ b и b ≤ c ⟹ a ≤ c
- Тотальность: Для всех a, b: a ≤ b или b ≤ a

**Тип:** A (математическое определение)

### L-1.4.2 Порядок через хеш-цепь

**Определение:** Слайс A < слайс B если существует путь хешей от A к B.

```
A → H(A) в B → H(B) в C → ...

A < B ⟺ ∃ путь A →* B по prev_hash
```

**Свойства:**
- Тотальный порядок на каноническойепи
- Partial order при наличии форков
- Fork-choice rule выбирает каноническую цепь

**Тип:** A (транзитивное замыкание хеш-ссылок)

### L-1.4.3 Fork-choice rule

```
Каноническая цепь = argmax(длина, вес)

1. Выбрать самую длинную цепь (количество слайсов)
2. При равной длине → наибольший суммарный вес присутствия
3. При равном весе → меньший хеш head слайса
```

**Тип:** A (детерминированный алгоритм)

### L-1.4.4 Зависимости

| Свойство | Зависит от | Режим отказа |
|----------|------------|--------------|
| Хеш-порядок | L-0.3.2 (CRHF) | Collision → ambiguity |
| Детерминизм | Алгоритм | Невозможен |
| Схождение | Сетевая связность | Partition → temporary forks |

---

## L-1.5 P2P-аттестация

### L-1.5.1 Определение

P2P-аттестация — механизм подтверждения присутствия через распространение подписей в реальном времени.

**Свойства:**
1. **Синхронность:** Подпись должна быть получена до закрытия τ₂
2. **Уникальность:** Один proof на узел на τ₁
3. **Верифицируемость:** Любой узел может проверить подпись
4. **Неизменность:** После закрытия τ₂ presence_root фиксирован

### L-1.5.2 Протокол

```
1. Узел создаёт PresenceProof(T):
   ├── timestamp: T
   ├── node_tier: тип узла
   ├── prev_slice_hash: хеш последнего τ₂
   └── signature: ML-DSA-65(sk, message)

2. Узел рассылает proof (gossip):
   └── Все peers получают proof

3. Peers проверяют:
   ├── Подпись валидна
   ├── Timestamp в пределах текущего τ₂
   ├── prev_slice_hash корректен
   └── Proof от этого узла для текущей минуты ещё отсутствует

4. Валидные proofs накапливаются в локальном пуле

5. При закрытии τ₂:
   └── Победитель формирует presence_root из пула
```

### L-1.5.3 Временное окно

```
τ₂ = 10 минут = 600 секунд

Proof для минуты M:
├── Должен быть получен сетью до закрытия τ₂
├── Опоздавший proof → переносится на следующий τ₂
└── Минута засчитывается при своевременной доставке

Gossip timeout: 30 секунд
├── Достаточно для глобального распространения
└── τ₂ >> gossip timeout
```

### L-1.5.4 Свойства безопасности

| Атака | Защита |
|-------|--------|
| Подписать прошлую координату | P2P сеть требует получение подписи в реальном времени |
| Подделать время получения | presence_root криптографически фиксирует полученные подписи |
| Накопить подписи заранее | prev_slice_hash формируется только при закрытии τ₂ |
| Внедрить подпись в старый слайс | Слайс уже подписан, хеш-цепь неизменна |

### L-1.5.5 Зависимости

| Свойство | Зависит от | Режим отказа |
|----------|------------|--------------|
| Подпись | L-0.3.3 (ML-LWE) | Forgery → fake proofs |
| Привязка к цепи | prev_slice_hash | Невозможен (криптографическая привязка) |
| Распространение | Сетевая связность | Partition → missed proofs |

### L-1.5.6 Транспортное шифрование

Все P2P соединения Montana используют гибридное пост-квантовое шифрование.

**Протокол: Noise XX + ML-KEM-768**

```
┌─────────────────────────────────────────────────────────────────┐
│                     NOISE XX + ML-KEM-768                       │
├─────────────────────────────────────────────────────────────────┤
│  Classical:     X25519 (ECDH)                                   │
│  Post-Quantum:  ML-KEM-768 (NIST FIPS 203)                      │
│  Symmetric:     ChaCha20-Poly1305                               │
│  Hash:          SHA3-256 (NIST FIPS 202)                        │
│  Hybrid Key:    HKDF(X25519_shared ‖ ML-KEM_shared)             │
└─────────────────────────────────────────────────────────────────┘
```

**Noise XX Pattern:**

```
→ e, kem_pk                   (initiator ephemeral + ML-KEM public key)
← e, ee, s, es, kem_ct        (responder ephemeral + static + ML-KEM ciphertext)
→ s, se                       (initiator static)
```

**Свойства (Тип S):**

| Свойство | Гарантия |
|----------|----------|
| Forward secrecy | Эфемерные ключи, прошлые сессии защищены |
| Mutual authentication | Обе стороны подтверждают идентичность |
| Identity hiding | Идентичность инициатора скрыта от пассивного наблюдателя |
| Post-quantum security | ML-KEM-768 устойчив к алгоритму Шора |
| Hybrid security | Сессия защищена пока один из примитивов безопасен |

**Гибридная безопасность:**

```
shared_secret = HKDF(X25519_dh ‖ ML-KEM_ss)

Безопасность сохраняется если:
├── X25519 безопасен ИЛИ
└── ML-KEM-768 безопасен

Атакующему необходимо нарушить ОБА примитива.
```

**Применение:**

1. **Все P2P соединения:** Noise handshake перед Montana протоколом
2. **Hardcoded узлы:** Дополнительная аутентификация через ML-DSA-65 (L-1.5.7)
3. **Защита от MITM:** Статические ключи узлов, публичный ключ = идентификатор

**Тип:** B (reduction к X25519 или ML-KEM) + S (безопасная композиция)

### L-1.5.7 Аутентификация hardcoded узлов

Hardcoded узлы используют дополнительную аутентификацию поверх Noise.

**Challenge-Response протокол:**

```
1. Client → Hardcoded:  AuthChallenge(random_32_bytes)
2. Hardcoded → Client:  AuthResponse(Version, ML-DSA-65_signature)
3. Client проверяет подпись против ожидаемого pubkey
```

**Хранение идентичности:**

```
hardcoded_identity.rs:
├── IP адрес привязан к ML-DSA-65 публичному ключу
├── Публичные ключи вкомпилированы в бинарник
└── Приватные ключи хранятся операторами (HSM рекомендовано)
```

**Защита от BGP/MITM:**

| Атака | Результат |
|-------|-----------|
| BGP hijack | Атакующий требует приватный ключ → AuthResponse невалиден |
| DNS poisoning | Клиент проверяет подпись, независимо от DNS |
| Man-in-the-middle | Noise шифрование + AuthResponse = двойная защита |

**Требования для Eclipse атаки:**

```
Для успешного Eclipse необходимо:
├── Приватные ключи 15+ hardcoded узлов
├── Контроль 51+ peers из 25+ /16 подсетей
└── Компрометация сетевой инфраструктуры ИЛИ insider threat
```

**Тип:** B (ML-DSA-65 security) + I (зависит от ключей операторов)

---

## L-1.6 Определения безопасности

### L-1.6.1 Неподделываемость (EUF-CMA)

**Определение:** Existential Unforgeability under Chosen Message Attack.

Создание валидной подписи на новом сообщении требует знания приватного ключа, даже при наличии подписей на выбранных сообщениях.

**Тип:** B (reduction к ML-LWE)

### L-1.6.2 Collision Resistance

**Определение:** Для хеш-функции H поиск x ≠ x' таких что H(x) = H(x') требует вычислений порядка O(2^{n/2}).

**Тип:** C (эмпирическая для конкретных функций)

**Birthday bound (Тип A):** Любой алгоритм поиска коллизий требует Ω(2^{n/2}) запросов для n-бит выхода.

### L-1.6.3 Preimage Resistance

**Определение:** Для хеш-функции H и значения y поиск x такого что H(x) = y требует вычислений порядка O(2^n).

**Тип:** C (эмпирическая)

### L-1.6.4 Детерминированность

**Определение:** Функция f детерминирована если для одинаковых входов всегда даёт одинаковые выходы.

**Тип:** A (математическое свойство)

### L-1.6.5 Temporal Binding

**Определение:** Данные D криптографически связаны с временной позицией T если изменение D или T требует нарушения криптографических предположений.

**Тип:** P + C (физическое время + hash binding)

---

## L-1.7 Правила композиции

### L-1.7.1 Последовательная композиция

**Теорема:** Если P1 безопасен и P2 безопасен, то P1; P2 (запустить P1 потом P2) безопасен.

**Тип:** S

**Условия:**
- Выход P1 — валидный вход P2
- Свойства безопасности совместимы

### L-1.7.2 Параллельная композиция

**Теорема:** Если P1 и P2 безопасны и имеют независимое состояние, то P1 ‖ P2 безопасен.

**Тип:** S

**Предупреждение:** Разделяемая рандомность или ключи могут нарушить безопасность.

### L-1.7.3 Montana композиция

```
Montana Slice = Timestamp ∘ P2P-Attestation ∘ Lottery ∘ Commitment

Безопасность:
├── Timestamp: хеш-цепь (C) + NMI (P)
├── P2P-Attestation: подписи (B) + gossip
├── Lottery: hash-based (C) + детерминизм (A)
└── Commitment: Merkle (C)

Композиция безопасна ⟸ все компоненты безопасны (S)
```

---

## L-1.8 Режимы отказа

### L-1.8.1 Если Слой -1 откажет

| Отказ L-1 | Влияние на Слой 1 |
|-----------|-------------------|
| L-1.1 (Порядок координат) | Ретроактивное присутствие возможно |
| L-1.2 (Атомное время) | NMI калибровка требует внешних источников времени |
| L-1.4 (Скорость света) | Мгновенное распространение |

**Митигация:** Физические законы образуют внешнюю границу модели безопасности.

### L-1.8.2 Если Слой 0 откажет

| Отказ L-0 | Влияние | Митигация |
|-----------|---------|-----------|
| SHA3-256 сломан | Hash-based примитивы сломаны | Переход на альтернативный хеш |
| ML-LWE сломан | Подписи подделываемы | Переход на альтернативную схему |
| P = NP | Все Type D сломаны | Физические ограничения остаются |

### L-1.8.3 Если конструкция откажет

| Отказ конструкции | Влияние | Восстановление |
|-------------------|---------|----------------|
| Конкретные параметры хеша | Этот инстанс уязвим | Увеличить параметры |
| Баг реализации | Инстанс уязвим | Патч и ротация ключей |
| Gossip attack | Задержка распространения | Увеличить τ₂ окно |

---

## L-1.9 Сводка примитивов Montana

| Примитив | Секция | Тип | Роль в Montana |
|----------|--------|-----|----------------|
| Детерминированная лотерея | L-1.1 | C + A | Выбор победителя |
| Hash commitment | L-1.2 | C | presence_root, tx_root |
| Linked timestamp | L-1.3 | P + C + B | Таймчейн |
| Hash-chain ordering | L-1.4 | A | Порядок слайсов |
| P2P-аттестация | L-1.5 | B + Network | Доказательство присутствия |

---

## L-1.10 Взаимодействие слоёв

```
┌─────────────────────────────────────────────────────────────┐
│  Слой 2+: Montana (ACP протокол)                           │
│  Использует: Лотерея, Timestamps, Ordering, Attestation    │
└─────────────────────────────────────────────────────────────┘
                              ↑ использует
┌─────────────────────────────────────────────────────────────┐
│  Слой 1: Протокольные примитивы                     v1.0  │
│  Лотерея, Commitment, Timestamp, Ordering, P2P-Attestation │
│  Типы: A, B, C, P, S, I                                    │
└─────────────────────────────────────────────────────────────┘
                              ↑ строится на
┌─────────────────────────────────────────────────────────────┐
│  Слой 0: Вычислительные ограничения                 v1.4  │
│  SHA3-256, ML-DSA-65, ML-KEM-768, Birthday, Grover        │
│  Типы: A, B, C, D, P                                       │
└─────────────────────────────────────────────────────────────┘
                              ↑ строится на
┌─────────────────────────────────────────────────────────────┐
│  Слой -1: Физические ограничения                    v3.0  │
│  Порядок координат, Атомное время, Ландауэр               │
│  Типы: 1, 2, 3, 4                                          │
└─────────────────────────────────────────────────────────────┘
```

---

## L-1.11 Литература

Lamport, L. (1978). "Time, Clocks, and the Ordering of Events in a Distributed System."
Haber, S., Stornetta, W.S. (1991). "How to Time-Stamp a Digital Document."
Merkle, R. (1987). "A Digital Signature Based on a Conventional Encryption Function."
NIST FIPS 202 (2015). SHA-3 Standard.
NIST FIPS 204 (2024). ML-DSA Standard.

---

---

*v1.4: Актуализация с кодом. Унификация терминологии.*
*v1.3: Транспортное шифрование Noise XX + ML-KEM-768. Аутентификация hardcoded узлов.*
*v1.2: P2P-аттестация расширена.*
*v1.1: Детерминированная лотерея.*
*v1.0: Протокольные примитивы Montana.*

*Слой 1 определяет протокольные примитивы Montana — криптографические строительные блоки с доказанными свойствами безопасности. Каждый примитив типизирован (A/B/C/P/S/I) с явными зависимостями и режимами отказа.*
